From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Raine Makelainen <raine.makelainen@jolla.com>
Date: Wed, 13 May 2015 07:51:44 -0700
Subject: [PATCH] [sailfishos][compositor] Respect
 gfxPrefs::ClearCompoisitorContext for clearing

Signed-off-by: Raine Makelainen <raine.makelainen@jolla.com>
---
 gfx/layers/opengl/CompositorOGL.cpp | 9 ++++++---
 gfx/thebes/gfxPrefs.h               | 3 +++
 2 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/gfx/layers/opengl/CompositorOGL.cpp b/gfx/layers/opengl/CompositorOGL.cpp
index e5ba3edc24bb..dab472c602f7 100644
--- a/gfx/layers/opengl/CompositorOGL.cpp
+++ b/gfx/layers/opengl/CompositorOGL.cpp
@@ -635,9 +635,12 @@ void CompositorOGL::BeginFrame(const nsIntRegion& aInvalidRegion,
     aClipRectOut->SetRect(0, 0, width, height);
   }
 
-  mGLContext->fClearColor(mClearColor.r, mClearColor.g, mClearColor.b,
-                          mClearColor.a);
-  mGLContext->fClear(LOCAL_GL_COLOR_BUFFER_BIT | LOCAL_GL_DEPTH_BUFFER_BIT);
+  // If clearing if done DrawWindowUnderlay respect the preference.
+  if (gfxPrefs::ClearCompoisitorContext()) {
+    mGLContext->fClearColor(mClearColor.r, mClearColor.g, mClearColor.b,
+                            mClearColor.a);
+    mGLContext->fClear(LOCAL_GL_COLOR_BUFFER_BIT | LOCAL_GL_DEPTH_BUFFER_BIT);
+  }
 }
 
 void CompositorOGL::CreateFBOWithTexture(const gfx::IntRect& aRect,
diff --git a/gfx/thebes/gfxPrefs.h b/gfx/thebes/gfxPrefs.h
index f6ede8186a31..a1da9eb6cf47 100644
--- a/gfx/thebes/gfxPrefs.h
+++ b/gfx/thebes/gfxPrefs.h
@@ -454,6 +454,9 @@ class gfxPrefs final {
   DECL_GFX_PREF(Once, "gfx.canvas.skiagl.cache-size",          CanvasSkiaGLCacheSize, int32_t, 96);
   DECL_GFX_PREF(Once, "gfx.canvas.skiagl.dynamic-cache",       CanvasSkiaGLDynamicCache, bool, false);
 
+  DECL_GFX_PREF(Once, "gfx.compositor.external-window",        UseExternalWindow, bool, false);
+  DECL_GFX_PREF(Once, "gfx.compositor.clear-context",          ClearCompoisitorContext, bool, true);
+
   DECL_GFX_PREF(Live, "gfx.color_management.enablev4",         CMSEnableV4, bool, false);
   DECL_GFX_PREF(Live, "gfx.color_management.mode",             CMSMode, int32_t,-1);
   // The zero default here should match QCMS_INTENT_DEFAULT from qcms.h
-- 
2.26.2

