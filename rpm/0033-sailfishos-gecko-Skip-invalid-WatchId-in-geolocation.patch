From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: "p.tumakaev" <p.tumakaev@omprussia.ru>
Date: Mon, 29 Jun 2020 14:29:52 +0300
Subject: [PATCH] [sailfishos][gecko] Skip invalid WatchId in
 geolocation.clearWatch(). Contributes to JB#50110

ClearWatch() stores passed WatchId in mClearedWatchIDs without checking
if it was previously generated by WatchPosition(). As a result, all
subsequent WatchPosition() with such invalid identifiers are automatically
canceled at the "Allow" stage.

Signed-off-by: Raine Makelainen <raine.makelainen@jolla.com>
---
 dom/geolocation/nsGeolocation.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/dom/geolocation/nsGeolocation.cpp b/dom/geolocation/nsGeolocation.cpp
index 55c41cd7ce71..66a0d6d9c20a 100644
--- a/dom/geolocation/nsGeolocation.cpp
+++ b/dom/geolocation/nsGeolocation.cpp
@@ -1280,7 +1280,7 @@ nsresult Geolocation::WatchPosition(GeoPositionCallback aCallback,
 
 NS_IMETHODIMP
 Geolocation::ClearWatch(int32_t aWatchId) {
-  if (aWatchId < 0) {
+  if (aWatchId < 0 || aWatchId >= mLastWatchId) {
     return NS_OK;
   }
 
-- 
2.26.2

